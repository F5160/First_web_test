<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>无缝音频衔接</title>
</head>
<body>
    <button id="playButton">播放音频</button>

    <script>
        // 音频文件路径
        const audioFileA = 'File/audio/bgm_full.mp3';
        const audioFileB = 'File/audio/bgm_loop.mp3';

        // 创建音频上下文
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // 加载音频文件
        async function loadAudio(url) {
            const response = await fetch(url);
            const arrayBuffer = await response.arrayBuffer();
            return await audioContext.decodeAudioData(arrayBuffer);
        }

        // 播放音频
        function playAudio(buffer, startTime, offset = 0) {
            const source = audioContext.createBufferSource();
            source.buffer = buffer;
            source.connect(audioContext.destination);
            source.start(startTime, offset);
            return source;
        }

        // 主逻辑
        async function main() {
            // 加载音频文件
            const bufferA = await loadAudio(audioFileA);
            const bufferB = await loadAudio(audioFileB);

            // 获取音频时长
            const durationA = bufferA.duration;
            const durationB = bufferB.duration;

            // 播放音频 A
            const startTime = audioContext.currentTime;
            const sourceA = playAudio(bufferA, startTime);

            // 监听音频 A 的结束事件
            sourceA.onended = () => {
                console.log('音频 A 播放完毕');

                // 在音频 A 结束后立即播放音频 B
                const playBTime = audioContext.currentTime;
                const sourceB = playAudio(bufferB, playBTime);

                // 音频 B 循环播放
                let currentBStartTime = playBTime + durationB;
                function loopB() {
                    const source = playAudio(bufferB, currentBStartTime);
                    currentBStartTime += durationB; // 直接使用完整时长
                    source.onended = loopB; // 递归调用实现循环
                }
                sourceB.onended = loopB; // 第一次播放结束后开始循环
            };
        }

        // 点击按钮开始播放
        document.getElementById('playButton').addEventListener('click', main);
    </script>
</body>
</html>